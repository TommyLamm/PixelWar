# 渲染管线与简单世界实现说明

## ✅ 已完成功能

### 1. Shader 类 (`src/Shader.h` 和 `src/Shader.cpp`)
- ✅ 从文件加载着色器源码
- ✅ 从字符串加载着色器源码（备用方案）
- ✅ 编译和链接着色器程序
- ✅ 完善的错误处理和日志输出
- ✅ 提供设置 uniform 变量的接口：
  - `setBool()`, `setInt()`, `setFloat()`
  - `setVec3()`, `setVec4()`
  - `setMat3()`, `setMat4()`

### 2. Mesh 类 (`src/Mesh.h` 和 `src/Mesh.cpp`)
- ✅ 管理 VAO、VBO、EBO
- ✅ 存储顶点数据（位置、法线、纹理坐标）
- ✅ 提供 `draw()` 方法用于渲染
- ✅ 支持索引渲染（使用 EBO）
- ✅ 自动清理资源（析构函数）
- ✅ 支持移动语义（性能优化）

### 3. Geometry 类 (`src/Geometry.h` 和 `src/Geometry.cpp`)
- ✅ `createCube()`: 创建立方体网格
  - 24 个顶点（每个面 4 个顶点）
  - 36 个索引（12 个三角形）
  - 包含位置、法线和纹理坐标
- ✅ `createPlane()`: 创建平面网格（地面）
  - 支持细分以获得更好的光照效果
  - 法线朝向 Y 轴正方向
  - 包含位置、法线和纹理坐标

### 4. Phong 光照模型着色器
- ✅ **顶点着色器** (`shaders/phong.vert`):
  - 接收顶点位置、法线、纹理坐标
  - 变换到世界空间
  - 使用法线矩阵变换法线
  - 输出到片段着色器
- ✅ **片段着色器** (`shaders/phong.frag`):
  - 实现 Phong 光照模型
  - 环境光分量
  - 漫反射分量（基于法线和光源方向）
  - 镜面反射分量（基于视角和反射方向）
  - 支持材质属性（环境光、漫反射、镜面反射系数、高光指数）

### 5. 场景渲染
- ✅ 大型平面作为地面（50x50 单位）
- ✅ 随机放置 10 个立方体作为障碍物
- ✅ 使用摄像机矩阵（View 和 Projection）确保透视正确
- ✅ 每个物体使用不同的材质属性
- ✅ 点光源照明

## 📁 文件结构

```
game/
├── src/
│   ├── Shader.h          # 着色器类头文件
│   ├── Shader.cpp        # 着色器类实现
│   ├── Mesh.h            # 网格类头文件
│   ├── Mesh.cpp          # 网格类实现
│   ├── Geometry.h        # 几何体生成头文件
│   ├── Geometry.cpp      # 几何体生成实现
│   ├── Camera.h          # 摄像机类（已存在）
│   ├── Camera.cpp        # 摄像机类实现（已存在）
│   └── main.cpp          # 主程序（已更新）
├── shaders/
│   ├── phong.vert        # Phong 光照顶点着色器
│   └── phong.frag        # Phong 光照片段着色器
└── CMakeLists.txt        # 构建配置（已更新）
```

## 🔧 核心功能说明

### Shader 类使用

```cpp
// 从文件加载
Shader shader("shaders/phong.vert", "shaders/phong.frag");

// 激活着色器
shader.use();

// 设置 uniform 变量
shader.setMat4("uModel", modelMatrix);
shader.setVec3("uLight_Position", lightPos);
shader.setFloat("uMaterial_Shininess", 32.0f);
```

### Mesh 类使用

```cpp
// 创建网格
Mesh cube = Geometry::createCube(1.0f);
Mesh ground = Geometry::createPlane(50.0f, 50.0f, 20, 20);

// 渲染网格
cube.draw();
```

### Phong 光照模型

光照计算包含三个分量：

1. **环境光 (Ambient)**:
   ```
   ambient = lightAmbient * materialAmbient
   ```

2. **漫反射 (Diffuse)**:
   ```
   diffuse = lightDiffuse * materialDiffuse * max(dot(normal, lightDir), 0.0)
   ```

3. **镜面反射 (Specular)**:
   ```
   specular = lightSpecular * materialSpecular * pow(max(dot(viewDir, reflectDir), 0.0), shininess)
   ```

最终颜色 = ambient + diffuse + specular

## 🎮 场景设置

### 光源配置
- **位置**: (5.0, 8.0, 5.0)
- **环境光**: (0.2, 0.2, 0.2)
- **漫反射**: (0.8, 0.8, 0.8)
- **镜面反射**: (1.0, 1.0, 1.0)

### 立方体材质
- **环境光系数**: (0.1, 0.2, 0.3)
- **漫反射系数**: (0.4, 0.6, 0.8)
- **镜面反射系数**: (1.0, 1.0, 1.0)
- **高光指数**: 32.0

### 地面材质
- **环境光系数**: (0.2, 0.3, 0.2)
- **漫反射系数**: (0.6, 0.8, 0.6)
- **镜面反射系数**: (0.5, 0.5, 0.5)
- **高光指数**: 16.0

### 立方体分布
- 随机生成 10 个立方体
- 分布在 20x20 的区域内
- 高度为 0.5（立方体中心在地面上方）

## 🚀 编译和运行

### 编译
```bash
cd build
cmake ..
cmake --build . --config Release
```

### 运行
```bash
.\Release\L4D2_NoEngine.exe
```

### 操作说明
1. **WASD**: 移动摄像机
2. **鼠标移动**: 旋转视角
3. **鼠标滚轮**: 调整 FOV（缩放）
4. **ESC**: 退出程序

## 📝 技术细节

### 顶点数据结构
```cpp
struct Vertex {
    glm::vec3 position;  // 位置 (x, y, z)
    glm::vec3 normal;   // 法线 (nx, ny, nz)
    glm::vec2 texCoord; // 纹理坐标 (u, v)
};
```

### VAO/VBO/EBO 设置
- **VAO**: 存储顶点属性配置
- **VBO**: 存储顶点数据
- **EBO**: 存储索引数据
- 使用 `glVertexAttribPointer` 设置属性布局

### 矩阵变换
- **Model Matrix**: 物体从局部空间到世界空间
- **View Matrix**: 从摄像机获取（使用 `Camera::GetViewMatrix()`）
- **Projection Matrix**: 从摄像机获取（使用 `Camera::GetProjectionMatrix()`）
- **Normal Matrix**: Model Matrix 的逆转置（用于法线变换）

### 深度测试
- 启用 `GL_DEPTH_TEST`
- 使用 `GL_LESS` 深度函数
- 确保正确的 3D 渲染顺序

## ✅ 总结

渲染管线系统已完全实现，包括：
- ✅ Shader 类（加载、编译、链接）
- ✅ Mesh 类（VAO/VBO/EBO 管理）
- ✅ Geometry 类（立方体和平面生成）
- ✅ Phong 光照模型（环境光、漫反射、镜面反射）
- ✅ 场景渲染（地面 + 随机立方体）
- ✅ 摄像机集成（透视关系正确）

系统已集成到主程序中，可以直接编译运行测试！

## 🔄 后续扩展方向

- [ ] 添加纹理支持
- [ ] 实现阴影映射
- [ ] 添加更多几何体（球体、圆柱体等）
- [ ] 实现模型加载（OBJ、FBX 等）
- [ ] 添加多光源支持
- [ ] 实现延迟渲染
- [ ] 添加后处理效果

